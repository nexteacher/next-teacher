name: MongoDB æ•°æ®åº“å¤‡ä»½

on:
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 00:00 è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 08:00ï¼‰
    # å¦‚æœéœ€è¦åŒ—äº¬æ—¶é—´é›¶ç‚¹ï¼Œä½¿ç”¨ 16:00 UTCï¼ˆåŒ—äº¬æ—¶é—´-8å°æ—¶ï¼‰
    - cron: '0 16 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  backup:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è·å–å½“å‰æ—¥æœŸ
        id: date
        run: |
          echo "date=$(TZ='Asia/Shanghai' date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          echo "datetime=$(TZ='Asia/Shanghai' date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_OUTPUT

      - name: å®‰è£… MongoDB æ•°æ®åº“å·¥å…·
        run: |
          wget https://fastdl.mongodb.org/tools/db/mongodb-database-tools-ubuntu2204-x86_64-100.9.4.tgz
          tar -zxvf mongodb-database-tools-ubuntu2204-x86_64-100.9.4.tgz
          sudo mv mongodb-database-tools-ubuntu2204-x86_64-100.9.4/bin/* /usr/local/bin/
          mongodump --version

      - name: æ‰§è¡Œæ•°æ®åº“å¤‡ä»½
        env:
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
        run: |
          mongodump --uri="$MONGODB_URI" --out="nexteacher"

      - name: å‹ç¼©å¤‡ä»½æ–‡ä»¶
        run: |
          tar -czf nexteacher-backup-${{ steps.date.outputs.date }}.tar.gz nexteacher/
          ls -lh nexteacher-backup-${{ steps.date.outputs.date }}.tar.gz

      - name: åˆ›å»º Release å¹¶ä¸Šä¼ å¤‡ä»½
        uses: softprops/action-gh-release@v1
        with:
          tag_name: backup-${{ steps.date.outputs.date }}
          name: æ•°æ®åº“å¤‡ä»½ ${{ steps.date.outputs.date }}
          body: |
            ğŸ“¦ MongoDB æ•°æ®åº“è‡ªåŠ¨å¤‡ä»½
            
            **å¤‡ä»½æ—¶é—´**: ${{ steps.date.outputs.datetime }} (åŒ—äº¬æ—¶é—´)
            **å¤‡ä»½å†…å®¹**: å®Œæ•´æ•°æ®åº“å¯¼å‡º
            
            ### å¦‚ä½•æ¢å¤
            ```bash
            # ä¸‹è½½å¤‡ä»½æ–‡ä»¶
            wget https://github.com/${{ github.repository }}/releases/download/backup-${{ steps.date.outputs.date }}/nexteacher-backup-${{ steps.date.outputs.date }}.tar.gz
            
            # è§£å‹
            tar -xzf nexteacher-backup-${{ steps.date.outputs.date }}.tar.gz
            
            # æ¢å¤åˆ° MongoDB
            mongorestore --uri="YOUR_MONGODB_URI" nexteacher/
            ```
          files: |
            nexteacher-backup-${{ steps.date.outputs.date }}.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: æ¸…ç†æ—§çš„ Releases (ä¿ç•™æœ€è¿‘ 30 å¤©)
        uses: dev-drprasad/delete-older-releases@v0.3.2
        with:
          keep_latest: 30
          delete_tags: true
          delete_tag_pattern: backup-
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

