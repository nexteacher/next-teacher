name: MongoDB Database Backup

on:
  schedule:
    # Run daily at UTC 16:00 (Beijing Time 00:00)
    # Beijing Time is UTC+8
    - cron: '0 16 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  backup:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get current date
        id: date
        run: |
          echo "date=$(TZ='Asia/Shanghai' date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          echo "datetime=$(TZ='Asia/Shanghai' date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_OUTPUT

      - name: Install MongoDB Database Tools
        run: |
          wget https://fastdl.mongodb.org/tools/db/mongodb-database-tools-ubuntu2204-x86_64-100.9.4.tgz
          tar -zxvf mongodb-database-tools-ubuntu2204-x86_64-100.9.4.tgz
          sudo mv mongodb-database-tools-ubuntu2204-x86_64-100.9.4/bin/* /usr/local/bin/
          mongodump --version

      - name: Verify MongoDB URI configuration
        env:
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
        run: |
          if [ -z "$MONGODB_URI" ]; then
            echo "‚ùå Error: MONGODB_URI is not set"
            echo "Please add MONGODB_URI in GitHub Settings ‚Üí Secrets and variables ‚Üí Actions"
            exit 1
          fi
          # Show only the prefix to confirm the secret is configured without exposing it
          echo "‚úÖ MONGODB_URI is configured (prefix: ${MONGODB_URI:0:20}...)"

      - name: Execute database backup
        env:
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
        run: |
          echo "Starting database backup..."
          mongodump --uri="$MONGODB_URI" --out="nexteacher"
          echo "Backup completed!"

      - name: Compress backup files
        run: |
          tar -czf nexteacher-backup-${{ steps.date.outputs.date }}.tar.gz nexteacher/
          ls -lh nexteacher-backup-${{ steps.date.outputs.date }}.tar.gz

      - name: Create Release and upload backup
        uses: softprops/action-gh-release@v1
        with:
          tag_name: backup-${{ steps.date.outputs.date }}
          name: Database Backup ${{ steps.date.outputs.date }}
          body: |
            üì¶ MongoDB Automatic Database Backup
            
            **Backup Time**: ${{ steps.date.outputs.datetime }} (Beijing Time)
            **Backup Content**: Complete database export
            
            ### How to Restore
            ```bash
            # Download backup file
            wget https://github.com/${{ github.repository }}/releases/download/backup-${{ steps.date.outputs.date }}/nexteacher-backup-${{ steps.date.outputs.date }}.tar.gz
            
            # Extract
            tar -xzf nexteacher-backup-${{ steps.date.outputs.date }}.tar.gz
            
            # Restore to MongoDB
            mongorestore --uri="YOUR_MONGODB_URI" nexteacher/
            ```
          files: |
            nexteacher-backup-${{ steps.date.outputs.date }}.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Clean up old releases (keep last 30 days)
        uses: dev-drprasad/delete-older-releases@v0.3.2
        with:
          keep_latest: 30
          delete_tags: true
          delete_tag_pattern: backup-
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

