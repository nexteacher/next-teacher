name: MongoDB 数据库备份

on:
  schedule:
    # 每天 UTC 时间 00:00 运行（北京时间 08:00）
    # 如果需要北京时间零点，使用 16:00 UTC（北京时间-8小时）
    - cron: '0 16 * * *'
  workflow_dispatch: # 允许手动触发

jobs:
  backup:
    runs-on: ubuntu-latest
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 获取当前日期
        id: date
        run: |
          echo "date=$(TZ='Asia/Shanghai' date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          echo "datetime=$(TZ='Asia/Shanghai' date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_OUTPUT

      - name: 安装 MongoDB 数据库工具
        run: |
          wget https://fastdl.mongodb.org/tools/db/mongodb-database-tools-ubuntu2204-x86_64-100.9.4.tgz
          tar -zxvf mongodb-database-tools-ubuntu2204-x86_64-100.9.4.tgz
          sudo mv mongodb-database-tools-ubuntu2204-x86_64-100.9.4/bin/* /usr/local/bin/
          mongodump --version

      - name: 执行数据库备份
        env:
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
        run: |
          mongodump --uri="$MONGODB_URI" --out="nexteacher"

      - name: 压缩备份文件
        run: |
          tar -czf nexteacher-backup-${{ steps.date.outputs.date }}.tar.gz nexteacher/
          ls -lh nexteacher-backup-${{ steps.date.outputs.date }}.tar.gz

      - name: 创建 Release 并上传备份
        uses: softprops/action-gh-release@v1
        with:
          tag_name: backup-${{ steps.date.outputs.date }}
          name: 数据库备份 ${{ steps.date.outputs.date }}
          body: |
            📦 MongoDB 数据库自动备份
            
            **备份时间**: ${{ steps.date.outputs.datetime }} (北京时间)
            **备份内容**: 完整数据库导出
            
            ### 如何恢复
            ```bash
            # 下载备份文件
            wget https://github.com/${{ github.repository }}/releases/download/backup-${{ steps.date.outputs.date }}/nexteacher-backup-${{ steps.date.outputs.date }}.tar.gz
            
            # 解压
            tar -xzf nexteacher-backup-${{ steps.date.outputs.date }}.tar.gz
            
            # 恢复到 MongoDB
            mongorestore --uri="YOUR_MONGODB_URI" nexteacher/
            ```
          files: |
            nexteacher-backup-${{ steps.date.outputs.date }}.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 清理旧的 Releases (保留最近 30 天)
        uses: dev-drprasad/delete-older-releases@v0.3.2
        with:
          keep_latest: 30
          delete_tags: true
          delete_tag_pattern: backup-
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

